\documentclass[12pt]{article}
\usepackage[a4paper, heightrounded,
	bindingoffset=6mm, left=10mm, right=40mm, marginparsep=5mm, marginparwidth=32.5mm,
	headheight=15pt, top=25mm, bottom=20mm]{geometry}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{xcolor}
\usepackage{setspace}

\let\phi\varphi
\let\from\gets
\def\ofA{\langle A \rangle}
\renewcommand{\a}[1]{\alpha_#1}

\newcommand\alert\textbf
\newcommand\todo[1]{{\color{red}TODO: #1}}

\usepackage{marginnote}
\usepackage{ragged2e}
\renewcommand*{\marginfont}{\normalfont\footnotesize}
\renewcommand*{\raggedleftmarginnote}{\RaggedRight}
\renewcommand*{\raggedrightmarginnote}{\RaggedRight}

\begin{document}


\subsection{Useful lemmas}
\paragraph{Lemma---AJD.} Suppose $b$ is a bank of a pond. Then there is a $\Gamma \in A^*$ such that $b \Gamma$ belongs to a doubly infinite $\phi$-orbit that meets $X$. 
\begin{proof}Induction on the width of the pond. Written in an email.\end{proof}

\paragraph{Lemma.} Suppose $\ell \in X\ofA \setminus Y\ofA$ and $r \in X\ofA \setminus Z\ofA$. Let $\Gamma$ be such that $\ell\Gamma$ belongs to a doubly infinite $\phi$-orbit. (Such a $\Gamma$ exists by AJD's lemma.) Then:
\begin{enumerate}
	\item \label{it:bank_test_down}
		If $(\ell, r)$ are banks of a pond, $\ell\Gamma$ and $r\Gamma$ share an orbit.
	\item \label{it:bank_test_up} 
		If $\ell\Gamma$ and $r\Gamma$ share an orbit, then there is at most one solution to the equation $\ell\phi^k = r$.
\end{enumerate}
\begin{proof}

\begin{enumerate}
	\item If $\ell\phi^k = r$, then $\ell\Gamma\phi^k = \ell \phi^k \Gamma = r \Gamma$.
	\item We will show that
	\begin{equation*}
		\ell\Gamma\phi^k = r \Gamma \implies (\text{If $\ell\phi^m = r$, then $k = m$}).
	\end{equation*}
	This is a statement of the form $A \implies (B \implies C)$, which is equivalent to the statement $\neg(A \land B \land \neg C)$. We prove the second statement by showing that $A \land B \land \neg C$ causes a contradiction.

	Suppose that $\ell\Gamma\phi^k = r\Gamma$, $\ell\phi^m = r$, and that $k \neq m$. It follows that  $\ell\Gamma\phi^m = r\Gamma = \ell\Gamma\phi^k$, meaning that $\ell\Gamma\phi^{m-k} = \ell \Gamma$. Since $k \neq m$, this means that $\ell\Gamma$ belongs to a periodic $\phi$-orbit. But this contradicts the fact that $\ell\Gamma$ is in a doubly-infinite orbit.
\end{enumerate}
\end{proof}

\subsubsection{Test for banks}
Now we outline a procedure to test if $(\ell, r)$ are banks of a pond.
\begin{enumerate}
	\item Find a string $\Gamma$ for which $\ell\Gamma$ is in a doubly infinite orbit.
	\item Run the orbit sharing test on $\ell\Gamma$ and $r\Gamma$.
	\item \alert{If} the test fails, then $(\ell, r)$ are not the banks of a pond. [This is the contrapositive of part \ref{it:bank_test_down}.]
	\item \alert{Else} we have $k$ such that $\ell\Gamma\phi^k = r \Gamma$. By part \ref{it:bank_test_up}, $(\ell, r)$ are banks if and only if $\ell\phi^k=r$. We can evaluate this equality.

\end{enumerate}

\subsection{Gathering pond data}

\begin{enumerate}
\item Construct the quasi-normal basis X as before, and compute $X\ofA \setminus Y\ofA$ and $X\ofA \setminus Z\ofA$.
\item \label{it:terminal_banks}
	\alert{For} each terminal element $\ell$ in $X\ofA \setminus Y\ofA$:
	
	\begin{enumerate}
		\item \label{it:iterate_descendants}
			Let $\Gamma$ iterate through $A^*$, starting with $\Gamma=1$, then words of length $1, 2, \dotsc$. \alert{For} each $\Gamma$:
			\begin{enumerate}
				\item Compute $w = \ell\Gamma \phi$.
				\item Test to see if $w$ belongs to a doubly-infinite type C $X$-component.
				\item \alert{If} so, \alert{break}.
			\end{enumerate}
		
		\item At this stage, we have $\ell\Gamma$ which belongs to a doubly infinite orbit. \marginnote{When I first wrote this, I used the proof of AJD's lemma to find $\Gamma$. This was probably more efficient but it was tricky to implement. I decided to keep things simple!.} Record the tuple $(\ell, \Gamma)$.
	\end{enumerate}

\item Let $R$ be a set. Initialise $R$ with the contents of $X\ofA \setminus Z\ofA$.

\item Try to match $\ell$ to $r\in R$. \alert{For} each $\ell \in X\ofA \setminus Y\ofA$:
	\begin{enumerate}
	\item \alert{For} each $r \in R$:
		\begin{enumerate}
		\item Use the previous procedure and the tuples $(\ell, \Gamma)$ to see if $(\ell, r)$ are banks of a pond.
		\item \alert{If} so, record this fact, taking note of the value $k$ for which $\ell\phi^k = r$. Then remove $r$ from $R$, \alert{break} and \alert{continue} to the next $\ell' \in L$.
		\end{enumerate}
		\item If we exhaust all remaining initial words $r$, then $\ell$ is in a genuinely left semi-infinite $\phi$-orbit.
	\end{enumerate}
	\item Any elements remaining in $R$ are in genuinely left semi-infinite $\phi$-orbits.
\end{enumerate}



\subsection{Modifications to the orbit-sharing test}
\begin{enumerate}
	\item Let us skip forward to the point where we assume $u, v \in X\ofA$. If it is true that $u$ and $v$ share an orbit, then either they belong to the same $X$-component, or they are separated by a pond.
	
	\item Look to see if $u$ is in a pond-orbit. \alert{For} each `bank' word $b$:
	\begin{enumerate}
		\item Run the orbit-sharing test on $b$ and $u$. Let $S$ denote the solution set.
		\item \alert{If} the test returns $S=\emptyset$, \alert{continue} to the next bank word.
		\item Run the component-sharing test on $(b, v)$ and $(b', v)$, where $b'$ is the other bank of the pond in question.
		\item \alert{If} one of these two tests returns a non-empty solution set, $u$ and $v$ share an orbit. Combine the two non-empty solution sets and \alert{return}.
		\item \alert{Else}, \alert{return} $\emptyset$.
	\end{enumerate}
	If we reach this point without returning, then $u$ does not lie in a pond orbit. It may be the case that $v$ \emph{does} lie in a pond orbit; but then this certainly means that $u$ and $v$ do not share an $X$-component. Thus the rest of the tests in Lemma 4.24.2 should conclude that $u$ and $v$ do not share an orbit.
\end{enumerate}

\paragraph{Remark} This is pretty clunky and involves repeatedly invoking the orbit-sharing test. When I came to implement this, instead of the above I did the following. When we compute the list  $(7)$ of Lemma 4.24, (which I've started calling the \emph{core} part of the component in question), I check to see if it contains a bank $\ell$. If not, then proceed as normal. Otherwise, I check to see which $r$ corresponds to $\ell$, and add the `core' part of the component containing $r$ to the list $(7)$.

\end{document}